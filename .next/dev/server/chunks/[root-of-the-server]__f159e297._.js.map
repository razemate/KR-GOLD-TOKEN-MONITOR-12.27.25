{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 40, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Chris%20Saulon/Downloads/APPS%20-%20PROTOTYPING/Gold%20Token%20Monitor%20-%20Lovable/src/app/api/gold-intel/route.ts"],"sourcesContent":["import { NextRequest } from 'next/server';\n\n// In-memory cache for responses\nlet cachedResponse: any = null;\nlet lastGeneratedAtMs: number | null = null;\n\n// Helper to determine if it's weekend in Pacific Time\nconst isPacificWeekend = (): boolean => {\n  const now = new Date();\n  // Use Intl API for accurate timezone conversion\n  const ptDateStr = now.toLocaleString('en-US', { timeZone: 'America/Los_Angeles' });\n  const ptDate = new Date(ptDateStr);\n  const day = ptDate.getDay();\n  return day === 0 || day === 6; // Sunday or Saturday\n};\n\n// Function to call Gemini API\nasync function callGemini(token: any, apiKey: string): Promise<{ summary: string, provider: string }> {\n  const prompt = `Analyze the tokenized gold token ${token.name} (${token.symbol.toUpperCase()}) with the following data:\n- Current price: $${token.current_price?.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} USD\n- Market cap: $${(token.market_cap / 1e9).toFixed(2)}B USD\n- 24h volume: $${(token.total_volume / 1e6).toFixed(2)}M USD\n- 24h change: ${token.price_change_percentage_24h > 0 ? '+' : ''}${token.price_change_percentage_24h?.toFixed(2)}%\n- Category: tokenized-gold\n\nProvide a concise analysis of this token's performance and position in the tokenized gold market.`;\n\n  const response = await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=' + apiKey, {\n    method: 'POST',\n    headers: {\n      'Content-Type': 'application/json',\n    },\n    body: JSON.stringify({\n      contents: [{\n        parts: [{\n          text: prompt\n        }]\n      }]\n    })\n  });\n\n  if (!response.ok) {\n    throw new Error(`Gemini API error: ${response.status}`);\n  }\n\n  const data = await response.json();\n  const summary = data.candidates?.[0]?.content?.parts?.[0]?.text || \"AI analysis temporarily unavailable.\";\n\n  return {\n    summary: summary.trim(),\n    provider: \"gemini\"\n  };\n}\n\n// Function to call OpenRouter API with specified model\nasync function callOpenRouter(token: any, apiKey: string, model: string): Promise<{ summary: string, provider: string }> {\n  const prompt = `Analyze the tokenized gold token ${token.name} (${token.symbol.toUpperCase()}) with the following data:\n- Current price: $${token.current_price?.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} USD\n- Market cap: $${(token.market_cap / 1e9).toFixed(2)}B USD\n- 24h volume: $${(token.total_volume / 1e6).toFixed(2)}M USD\n- 24h change: ${token.price_change_percentage_24h > 0 ? '+' : ''}${token.price_change_percentage_24h?.toFixed(2)}%\n- Category: tokenized-gold\n\nProvide a concise analysis of this token's performance and position in the tokenized gold market.`;\n\n  const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {\n    method: 'POST',\n    headers: {\n      'Authorization': `Bearer ${apiKey}`,\n      'Content-Type': 'application/json',\n    },\n    body: JSON.stringify({\n      model: model,\n      messages: [\n        { role: 'user', content: prompt }\n      ]\n    })\n  });\n\n  if (!response.ok) {\n    throw new Error(`OpenRouter API error: ${response.status}`);\n  }\n\n  const data = await response.json();\n  const summary = data.choices?.[0]?.message?.content || \"AI analysis temporarily unavailable.\";\n\n  return {\n    summary: summary.trim(),\n    provider: model.includes('devstral') ? \"openrouter-devstral\" : \"openrouter-gpt-oss\"\n  };\n}\n\n// Function to analyze a single token with fallback chain\nasync function analyzeToken(token: any): Promise<{ summary: string, generatedAt: string, provider: string }> {\n  const generatedAt = new Date().toISOString();\n\n  // Try Gemini first (primary)\n  try {\n    const geminiKey = process.env.GEMINI_API_KEY;\n    if (geminiKey) {  // Only try if key exists\n      return await callGemini(token, geminiKey);\n    }\n  } catch (geminiError) {\n    console.warn(`Gemini failed for ${token.id}:`, geminiError);\n  }\n\n  // Try OpenRouter devstral (first fallback)\n  try {\n    const openrouterKey = process.env.OPENROUTER_TOKENIZED_GOLD_KEY;\n    if (openrouterKey) {  // Only try if key exists\n      return await callOpenRouter(token, openrouterKey, \"mistralai/devstral-2512:free\");\n    }\n  } catch (devstralError) {\n    console.warn(`OpenRouter devstral failed for ${token.id}:`, devstralError);\n  }\n\n  // Try OpenRouter GPT OSS (second fallback)\n  try {\n    const openrouterKey = process.env.OPENROUTER_TOKENIZED_GOLD_KEY;\n    if (openrouterKey) {  // Only try if key exists\n      return await callOpenRouter(token, openrouterKey, \"openai/gpt-oss-120b:free\");\n    }\n  } catch (gptError) {\n    console.warn(`OpenRouter GPT OSS failed for ${token.id}:`, gptError);\n  }\n\n  // If all fail, return default message\n  return {\n    summary: \"AI analysis temporarily unavailable.\",\n    generatedAt,\n    provider: \"fallback\" // Indicate this is a fallback response\n  };\n}\n\nexport async function GET(request: NextRequest) {\n  // Read environment variables STRICTLY as specified\n  const coingeckoKey = process.env.COINGECKO_API_KEY;\n  const geminiKey = process.env.GEMINI_API_KEY;\n  const openrouterKey = process.env.OPENROUTER_TOKENIZED_GOLD_KEY;\n\n  // Implement strict env check - only show \"API keys not configured\" when keys are truly missing\n  if (!coingeckoKey) {\n    return new Response(JSON.stringify({\n      error: \"MISSING_ENV\",\n      missing: [\"COINGECKO_API_KEY\"]\n    }), {\n      status: 500,\n      headers: {\n        'Content-Type': 'application/json',\n        'Cache-Control': 'no-store',\n      },\n    });\n  }\n\n  // Check if both Gemini and OpenRouter keys are missing (meaning no AI analysis possible)\n  if (!geminiKey && !openrouterKey) {\n    return new Response(JSON.stringify({\n      error: \"MISSING_ENV\",\n      missing: [\"GEMINI_API_KEY\", \"OPENROUTER_TOKENIZED_GOLD_KEY\"]\n    }), {\n      status: 500,\n      headers: {\n        'Content-Type': 'application/json',\n        'Cache-Control': 'no-store',\n      },\n    });\n  }\n\n  try {\n    // Determine refresh cadence based on Pacific time\n    const isWeekend = isPacificWeekend();\n    const cadenceMinutes = isWeekend ? 15 : 5;\n    const nowMs = Date.now();\n\n    // Check if we have a cached response and if it's still within the cadence window\n    if (cachedResponse && lastGeneratedAtMs) {\n      const timeSinceLastGeneration = (nowMs - lastGeneratedAtMs) / (1000 * 60); // in minutes\n\n      if (timeSinceLastGeneration < cadenceMinutes) {\n        // Return cached response\n        return new Response(JSON.stringify(cachedResponse), {\n          status: 200,\n          headers: {\n            'Content-Type': 'application/json',\n            'Cache-Control': 'no-store',\n          },\n        });\n      }\n    }\n\n    // Fetch tokenized gold data from CoinGecko - exactly as specified\n    const coingeckoUrl = 'https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&category=tokenized-gold&order=market_cap_desc&per_page=10&page=1&sparkline=false';\n\n    const coingeckoResponse = await fetch(coingeckoUrl, {\n      headers: {\n        'x-cg-pro-api-key': coingeckoKey!,\n        'Accept': 'application/json',\n      },\n      cache: 'no-store'\n    });\n\n    if (!coingeckoResponse.ok) {\n      throw new Error(`CoinGecko API error: ${coingeckoResponse.status} ${coingeckoResponse.statusText}`);\n    }\n\n    const tokensData = await coingeckoResponse.json();\n\n    // Process and format token data to match expected structure - exactly 10 tokens\n    const tokens = tokensData.map((t: any) => ({\n      id: t.id,\n      sym: (t.symbol || '').toUpperCase(),\n      name: t.name,\n      img: t.image,\n      price: t.current_price,\n      cap: t.market_cap,\n      chg: t.price_change_percentage_24h,\n      high: t.high_24h,\n      low: t.low_24h,\n      volume: t.total_volume,\n      circSupply: t.circulating_supply,\n      totalSupply: t.total_supply,\n      ath: t.ath,\n      athDate: t.ath_date,\n      atl: t.atl,\n      atlDate: t.atl_date,\n      spark: [] // We're not fetching sparkline data per requirements\n    }));\n\n    // Generate AI analysis for each token concurrently - exactly 10 analyses\n    const analysisPromises = tokens.map(token => analyzeToken(token));\n    const analysesArray = await Promise.all(analysisPromises);\n\n    // Create analyses object with token IDs as keys\n    const analyses: Record<string, { summary: string, generatedAt: string, provider: string }> = {};\n    tokens.forEach((token, index) => {\n      analyses[token.id] = analysesArray[index];\n    });\n\n    // Create the response object\n    const response = {\n      tokens,\n      analyses,\n      generatedAt: new Date().toISOString(),\n      refreshPolicy: {\n        timezone: \"America/Los_Angeles\",\n        cadenceMinutes,\n        isWeekend\n      }\n    };\n\n    // Update cache\n    cachedResponse = response;\n    lastGeneratedAtMs = nowMs;\n\n    // Return response\n    return new Response(JSON.stringify(response), {\n      status: 200,\n      headers: {\n        'Content-Type': 'application/json',\n        'Cache-Control': 'no-store',\n      },\n    });\n  } catch (error: any) {\n    console.error('Error in gold-intel API:', error);\n\n    return new Response(JSON.stringify({\n      error: error.message || 'Internal server error'\n    }), {\n      status: 500,\n      headers: {\n        'Content-Type': 'application/json',\n        'Cache-Control': 'no-store',\n      },\n    });\n  }\n}"],"names":[],"mappings":"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"}}]
}